<body th:replace="~{base :: layout (~{:: main})}">
    <main>
        <a href="javascript:void(0)" onclick="javascript:scanRemoteForProjets()">scan projets</a>
        <table class="table table-hover">
            <tr>
                <th scope="col"></th>
                <th scope="col">Name</th>
                <th scope="col">Comments to discuss</th>
                <th scope="col">Total Comments</th>
                <th scope="col">Actions</th>
            </tr>
            <tr th:each="project : ${projects}" class="project-item" th:data-project-id="${project.id}">
                <td><a  th:href="${project.url}" target="_blank"><i class="bi bi-arrow-up-right-square"/></a></td>
                <td th:text="${project.name}"></td>
                <td th:text="${project.commentsTotal}"></td>
                <td th:text="${project.commentsDiscussed}"></td>
                <td th:id="'actions-' + ${project.id}">
                    <span th:if="${project.state == T(org.divulgit.type.ProjectState).NEW}">
                        [<a href="javascript:void(0)" onclick="javascript:scanFrom(getProjectId(this))">scan from </a>
                        <input  type="text"
                                th:id="'scan-from-' + ${project.id}"
                                value="0"
                                size="2"
                                style="font-size: xx-small;"
                                title="Fill with the number of merge request that you started to hash tag comments">]
                        [<a href="javascript:void(0)" onclick="ignoreProject(getProjectElement(this), getProjectId(this));">ignore</a>]
                    </span>
                    <span th:if="${project.state == T(org.divulgit.type.ProjectState).ACTIVE}">
                        [<a href="javascript:void(0)" onclick="javascript:scanLastest(getProjectId(this))">rescan</a>]
                            <!--
                            [<a href="javascript:void(0)" onclick="scanComments('${project.id}');">scan comments</a>]
                            -->
                        [<a href='/mergeRequests/project/${project.id}'>merge requests</a>]
                    </span>
                </td>
            </tr>
        </table>
        <script>
            function scanRemoteForProjets(){
                $.ajax({
                    url:'/in/rest/remote/scan',
                    method:'post',
                    dataType:'json',
                    success:function(data, textStatus, xhr){
                        if (xhr.status == 200) {
                            alert('Scan queued, refresh later');
                        } else {
                            alert('some error occurred try again');
                        }
                    },
                    error:function(response){
                        alert('server error occured')
                    }
                });
            }

            function ignoreProject(projectElement, projectId){
                $.ajax({
                    url:'/in/project/'+ projectId +'/ignore',
                    method:'post',
                    success:function(data, textStatus, jqXHR){
                        console.log(mainItem);
                        if (jqXHR.status == 200) {
                            $(projectElement).hide(250);
                        } else {
                            alert('some error occurred try again');
                        }
                    },
                    error:function(jqXHR, textStatus, errorThrown){
                        console.log(jqXHR);
                        console.log(textStatus);
                        console.log(errorThrown);
                        alert('server error occured')
                    }
                });
            }

            function scanFrom(projectId){
                const scanFrom = $("#scan-from-" + projectId).val();
                if (!scanFrom) {
                    alert('Please, fill the initial merge request number to consider in scanning. This is the mergerequest that your team started hashtagging')
                } else {
                    $.ajax({
                        url:'/in/project/' + projectId + '/scanFrom/' + scanFrom + '/',
                        method:'post',
                        dataType:'json',
                        success:function(data, textStatus, xhr){
                            if (xhr.status == 200) {
                                $("#actions-"+projectId).html('scanning...');
                            }
                            console.log(response)
                        },
                        error:function(response){
                            alert('server error occured')
                        }
                    });
                }
            }

            function scanLastest(projectId){
                $.ajax({
                    url:'/in/project/' + projectId + '/scanFrom/lastest/',
                    method:'post',
                    dataType:'json',
                    success:function(data, textStatus, xhr){
                        if (xhr.status == 200) {
                            $("#actions-"+projectId).html('scanning...');
                        }
                        console.log(response)
                    },
                    error:function(response){
                        alert('server error occured')
                    }
                });
            }

            function getProjectId(element) {
                return getProjectElement(element).attr("data-project-id");
            }

            function getProjectElement(actualElement) {
                return $(actualElement).parents(".project-item")
            }

        </script>
    </main>
</body>